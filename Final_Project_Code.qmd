<<<<<<< HEAD
---
title: "Final_Project_Code"
date: now
author: "Elliot Kunz, Andrea Pareja, Anson Wu, Caroline Ritchey"
format: 
  html:
    embed-resources: true
    code-tools: true
    code-fold: true
    toc: true
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

```{r setup}
library(tidyverse)
library(knitr)
library(kableExtra)
library(broom)
library(gganimate)
```

## Introduction

### Data Descriptions

In this analysis, we use data collected by Gallup World Poll on November 20, 2024 which contains the national average response to the question of life evaluations. We additionally include information from a data set provided by Gapminder on the mean daily household per capital income. Our analysis includes the years 2005 - 2023. We omitted any countries and years who had missing values for either the happiness score or their mean daily household per capital income.

### Hypothesis

We believe that as daily income increases, so does the happiness score (WHR). Typically higher incomes means more financial freedom, this lowers the stress that is built up from worrying about financial problems like cost of living. In the article, “Does more money correlate with greater happiness?” by Michele W. Berger, Matthew Killingsworth argues that “for most people larger incomes are associated with greater happiness” (Berger 2023).

## Data Cleaning

We transformed both data sets to long format so that they could be joined by year and country. We also removed missing values.

```{r}
data1 <- read_csv("hapiscore_whr.csv", show_col_types = F)
data2 <- read_csv("mincpcap_cppp.csv", show_col_types = F)

clean_data1 <- data1 %>% 
  pivot_longer(cols = `2005`:`2023`,
              names_to = "year",
              values_to = "happiness")

clean_data2 <- data2 %>% 
  pivot_longer(cols = `1800`:`2100`,
              names_to = 'year',
              values_to = "daily_income")
  
data <- clean_data1 %>% 
  inner_join(clean_data2, 
             by = join_by(country == country, year == year)) %>% 
  na.omit()

kable(sample_n(data, size = 10), col.names = c("Country", "Year", "Happiness"," Daily Income"), align = "c", digits = 2)
```

## Modeling the Relationship between Happiness and Daily Income

### Displaying the Relationship

```{r}
grouped_data <- data %>% 
  group_by(country) %>% 
  summarise(happiness = mean(happiness), 
            daily_income = mean(daily_income))


ggplot(data = grouped_data, mapping = aes(x = log(daily_income), y = happiness))+
  geom_point()+
  geom_smooth(colour = "blue", method = lm)+
  labs(x = "Daily Income (log(Mean over the years))", 
       y = "Happiness Score (Mean over the years)", 
       title = "Scatterplot of Happiness compared to Daily Income")

```

This scatter plot shows the mean happiness score compared to daily income. Each dot on the plot represents the mean happiness per log of daily income. Here we can see that the trend of happiness increasing as daily income also increases. 

### Trends Over Time

```{r}
animated_plot <- ggplot(data = data, mapping = aes(x = log(daily_income), y = happiness)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue", alpha = 0.5) +
  transition_states(
    year,
    transition_length = 2,
    state_length = 1
  ) +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out') +
  labs(
    x = "log(Daily Income)", 
    y = "Happiness Score", 
    title = "Happiness vs Daily Income by Country",
    subtitle = "Year: {closest_state}") +
  theme_minimal()

animate(animated_plot, 
        width = 800, 
        height = 600, 
        fps = 10,
        renderer = gifski_renderer("happiness_animation.gif"))
```

![](happiness_animation.gif)

We used the mean score of the Happiness score and Daily Income for each country. The relationship of the variables followed a logarithmic distribution which we then transformed to get a linear relationship by using the logarithmic function on mean of Daily Income over the years 2005 to 2023. We then get a nicely formatted linear relationship between the log of the mean Daily Income and mean Happiness Score.

Based on the animated plot the line over time stays relativly the same with some years having a stronger relationship than other years. We still see a positive relationship in all years between the log of the mean daily income and happiness score which indicates that the log of the mean daily income could be a strong predictor of the happiness score of a country.

### Linear Regression

```{r}
model <- lm(happiness ~ log(daily_income), data = grouped_data)
```

We made a model to predict the mean Happiness Score based on the log of the mean Daily Income for each country, using the years 2005 to 2023.

```{r}
#| warning: false
tidy(model$coefficients) %>% 
  kable(col.names = c("Predictor Names", "Regression Coefficients"), align = 'c', digits = 2) %>% 
  kableExtra::kable_classic() %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(bold = TRUE, c("Table of Coefficients for Fitted Model" = 2))
```

${\hat{HappinessScore}} = 31.59 + 8.73*log(DailyIncome)$

We predict that a country with a log of their mean daily income equal to 0 will have a mean happiness score of 31.59 over the years 2005 to 2023.

If we multiply the mean Daily Income by e, we predict a increase of 8.73 in the mean Happiness Score.

### Model Fit

```{r}
aug_data <- model %>%
  augment()

data.frame(
  Var_Response_A = var(aug_data$happiness),
  Var_Fitted_B = var(aug_data$.fitted),
  Var_Residuals = var(aug_data$.resid),
  R_Squared = summary(model)$r.squared
) %>% 
  kable(align = "c") %>%
  kableExtra::kable_classic() %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(bold = TRUE, c("Model Variance Table" = 4)) %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "bordered"))
# https://broom.tidymodels.org/reference/augment.lm.html
```

The total variance in Happiness Score is 133.57. 82.10 of this is accounted for by the regression model based on the log of the mean daily income. The other 31.48 is unexplained. The R squared value of 0.7228 means that 72.28% of the variability in happiness can be explained by the log of daily income. The value comes from dividing the variance in Happiness Score explained by the model by the total variance in Happiness Score. This is a rather high percent and suggests that this is a well fit model that is able to identify the main trend in this data.

#### Discussion of Quality of the Model

The proportion of variability for Happiness Score explained by the log of daily income is .7228, which means that 72.28% of the variability in Happiness Score can be explained by the log of daily income. This suggests that the quality of our model is good.

## Cross-Validation

### 3.1 Implementing k-fold cross validation

```{r}

process_folds <- function(index) {
    train_data <- data[-index, ]
    val_data <- data[index, ]
    model <- lm(happiness ~ daily_income, data = train_data)
    predict <- predict(model, newdata = val_data)
    r2 <- (var(predict) / var(val_data[["happiness"]]))
    return(r2)
  }

kfold_cv <- function(data, k = 16, seed = 23) {
  set.seed(seed)
  n <- nrow(data)
  fold_ids <- sample(rep_len(1:k, length.out = n))
  folds <- map(1:k, ~ which(fold_ids == .x))
  r2_values <- map_dbl(folds, process_folds)
  results <- data.frame(fold = 1:k, R2 = r2_values)
  return(results)
}

k_fold <- kfold_cv(grouped_data)
k_fold

```

### 3.2 Plotting the results

```{r}
ggplot(data = k_fold)+
  geom_col(mapping = aes(x = fold, y = R2))+
  geom_hline(yintercept = mean(k_fold$R2), color = "blue") +
  labs(title = "R-Squared Values per Fold",
       x = "Fold Number used for Test Data",
       y = "R-Squared Value", 
       caption = "Average R-squared value is shown by Blue Line")
```

The Average R-squared values, shown by the blue line, falls just below 0.6. This means that less than 60% of the variability in the outcome can be explained by the model. Slightly more than 40% of the variance it still unexplained, which makes the predictive power of this model moderate. There is also a good amount of variability between folds which means that some of them have better predictions than others. 

## Conclusion

Throughout our analysis, we were curious about answering the central question proposed by Michele W. Berger: "Does more money correlate with greater happiness?" We have focused on the relationship between daily income and happiness, leading us to discover that there is indeed a positive relationship between the two. The data set we used were prepared by omitting any countries and years that had missing values. Our linear regression model showed that there is extremely strong evidence of a positive relationship happiness scores and daily income throughout the years for over 150 countries. The model shows that this relationship explains for 72.28% of the variation in Happiness Score. For confirmation of this relationship, we conducted a 16-fold cross validation which showed that there was a consistent relationship, strengthening our findings.

The analysis of the positive relationship between daily income and happiness scores in various countries corroborates theories about the way money can help alleviate stressors caused by lack of finances. The increase of money can be used to access housing, better healthcare, more fulfilling experiences, and much more. Although we found that higher daily incomes are associated with higher happiness scores, happiness can be influenced by other things that are not gathered by daily income like personal values and religion.

Our model does have limitations. We can see that there is a positive relationship between daily income and happiness scores. However, it is important to acknowledge that there can be a point where money can have diminishing returns in terms of happiness. Infinite money would not necessarily mean infinite happiness. So, although money cannot buy happiness, money seems to be a basis where it can expand the opportunities to increase happiness.

## Works Cited

Berger, Michele W. “Does More Money Correlate with Greater Happiness?” Penn Today, University of Pennsylvania, 6 Mar. 2023, penntoday.upenn.edu/news/does-more-money-correlate-greater-happiness-Penn-Princeton-research.

Helliwell, John F., et al. "World Happiness Report 2024." The World Happiness Report, 20 Mar. 2024, [worldhappiness.report/ed/2024/](http://worldhappiness.report/ed/2024/).

"Poverty and Inequality Platform." Poverty and Inequality Platform, 2022, [pip.worldbank.org/#](http://pip.worldbank.org/#).
=======
---
title: "Final_Project_Code"
date: now
author: "Elliot Kunz, Andrea Pareja, Anson Wu, Caroline Ritchey"
format: 
  html:
    embed-resources: true
    code-tools: true
    code-fold: true
    toc: true
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

```{r setup}
library(tidyverse)
library(knitr)
library(kableExtra)
library(broom)
library(gganimate)
```

## Introduction

### Data Descriptions

In this analysis, we use data collected by Gallup World Poll on November 20, 2024 which contains the national average response to the question of life evaluations. We additionally include information from a data set provided by Gapminder on the mean daily household per capital income. Our analysis includes the years 2005 - 2023. We omitted any countries and years who had missing values for either the happiness score or their mean daily household per capital income.

### Hypothesis

We believe that as daily income increases, so does the happiness score (WHR). Typically higher incomes means more financial freedom, this lowers the stress that is built up from worrying about financial problems like cost of living. In the article, “Does more money correlate with greater happiness?” by Michele W. Berger, Matthew Killingsworth argues that “for most people larger incomes are associated with greater happiness” (Berger 2023).

## Data Cleaning

We transformed both data sets to long format so that they could be joined by year and country. We also removed missing values.

```{r}
data1 <- read_csv("hapiscore_whr.csv", show_col_types = F)
data2 <- read_csv("mincpcap_cppp.csv", show_col_types = F)

clean_data1 <- data1 %>% 
  pivot_longer(cols = `2005`:`2023`,
              names_to = "year",
              values_to = "happiness")

clean_data2 <- data2 %>% 
  pivot_longer(cols = `1800`:`2100`,
              names_to = 'year',
              values_to = "daily_income")
  
data <- clean_data1 %>% 
  inner_join(clean_data2, 
             by = join_by(country == country, year == year)) %>% 
  na.omit()

kable(sample_n(data, size = 10), col.names = c("Country", "Year", "Happiness"," Daily Income"), align = "c", digits = 2) %>% 
    kableExtra::kable_classic() %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(bold = TRUE, c("Sample of Data giving Happiness Score and Daily Income for each Country and Year between 2005 to 2023" = 4))
```

## Modeling the Relationship between Happiness and Daily Income

We used the mean score of the Happiness score and the Daily Income for each country. The relationship of the variables followed a logarithmic distribution which we then transformed to get a linear relationship by using the logarithmic function on mean of Daily Income over the years 2005 to 2023. We then get a nicely formatted linear relationship between the log of the mean Daily Income and mean Happiness Score, as shown below. 

```{r}
grouped_data <- data %>% 
  group_by(country) %>% 
  summarise(happiness = mean(happiness), 
            daily_income = mean(daily_income))


ggplot(data = grouped_data, mapping = aes(x = log(daily_income), y = happiness))+
  geom_point()+
  geom_smooth(colour = "blue", method = lm)+
  labs(x = "Daily Income (log(Mean over the years))", 
       y = "Happiness Score (Mean over the years)", 
       title = "Scatterplot of Happiness compared to Daily Income")

```

We then choose to look at the linear relationship for each of the years and plot them to see how the relationship changed over time. We still used the model of mean Happiness score determined by the mean Daily income for each country but this time we see the relationship over the years. 


```{r}
animated_plot <- ggplot(data = data, mapping = aes(x = log(daily_income), y = happiness)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue", alpha = 0.5) +
  transition_states(
    year,
    transition_length = 2,
    state_length = 1
  ) +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out') +
  labs(
    x = "log(Daily Income)", 
    y = "Happiness Score", 
    title = "Happiness vs Daily Income by Country",
    subtitle = "Year: {closest_state}") +
  theme_minimal()

animate(animated_plot, 
        width = 800, 
        height = 600, 
        fps = 10,
        renderer = gifski_renderer("happiness_animation.gif"))
```

![](happiness_animation.gif)

Based on the animated plot the line over time stays relativly the same with some years having a stronger relationship than other years. We still see a positive relationship in all years between the log of the mean daily income and happiness score which indicates that the log of the mean daily income could be a strong predictor of the happiness score of a country.

### Linear Regression

```{r}
model <- lm(happiness ~ log(daily_income), data = grouped_data)
```

We made a model to predict the mean Happiness Score based on the log of the mean Daily Income for each country, using the years 2005 to 2023.

```{r}
#| warning: false
tidy(model$coefficients) %>% 
  kable(col.names = c("Predictor Names", "Regression Coefficients"), align = 'c', digits = 2) %>% 
  kableExtra::kable_classic() %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(bold = TRUE, c("Table of Coefficients for Fitted Model" = 2))
```

${\hat{HappinessScore}} = 31.59 + 8.73*log(DailyIncome)$

We predict that a country with a log of their mean daily income equal to 0 will have a mean happiness score of 31.59 over the years 2005 to 2023.

If we multiply the mean Daily Income by e, we predict a increase of 8.73 in the mean Happiness Score.

### Model Fit

```{r}
aug_data <- model %>%
  augment()

data.frame(
  Var_Response_A = var(aug_data$happiness),
  Var_Fitted_B = var(aug_data$.fitted),
  Var_Residuals = var(aug_data$.resid),
  R_Squared = summary(model)$r.squared
) %>% 
  kable(align = "c") %>%
  kableExtra::kable_classic() %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(bold = TRUE, c("Model Variance Table" = 4)) %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "bordered"))
# https://broom.tidymodels.org/reference/augment.lm.html
```

The total variance in Happiness Score is 133.57. 82.10 of this is accounted for by the regression model based on the log of the mean daily income. The other 31.48 is unexplained. The R squared value of 0.7228 means that 72.28% of the variability in happiness can be explained by the log of daily income. The value comes from dividing the variance in Happiness Score explained by the model by the total variance in Happiness Score. This is a rather high percent and suggests that this is a well fit model that is able to identify the main trend in this data.

#### Discussion of Quality of the Model

The proportion of variability for Happiness Score explained by the log of daily income is .7228, which means that 72.28% of the variability in Happiness Score can be explained by the log of daily income. This suggests that the quality of our model is good.

## Cross-Validation

We used cross validation to determine the mean R Squared for our model. R squared is a measure of the amount of varainace in Happiness that is explained by Dialy Income, thus a good overall predictor of the overall performance of the model. We did cross validation to determine the mean R squared because the R squared for a random sample can be very varied thus taking the mean of this value gives the best metric for overall performance. 


```{r}

process_folds <- function(index) {
    train_data <- data[-index, ]
    val_data <- data[index, ]
    model <- lm(happiness ~ daily_income, data = train_data)
    predict <- predict(model, newdata = val_data)
    r2 <- (var(predict) / var(val_data[["happiness"]]))
    return(r2)
  }

kfold_cv <- function(data, k = 16, seed = 23) {
  set.seed(seed)
  n <- nrow(data)
  fold_ids <- sample(rep_len(1:k, length.out = n))
  folds <- map(1:k, ~ which(fold_ids == .x))
  r2_values <- map_dbl(folds, process_folds)
  results <- data.frame(fold = 1:k, R2 = r2_values)
  return(results)
}

k_fold <- kfold_cv(grouped_data)
k_fold %>% 
  kable(col.names = c("Fold", "R- Squaared Value"), align = 'c', digits = 4) %>% 
  kableExtra::kable_classic() %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(bold = TRUE, c("R-Squared Value for each Fold" = 2))
  
```

The mean of our R sqaured's from cross vaslidation was 0.5629. This means that 56.29% of the vairation in Happiness score is explained by Daily Income in out model. Below is a grpah plotting the R Squared values with their respective folds


```{r}
ggplot(data = k_fold)+
  geom_col(mapping = aes(x = fold, y = R2))+
  geom_hline(yintercept = mean(k_fold$R2), color = "blue") +
  labs(title = "R-Squared Values per Fold",
       x = "Fold Number used for Test Data",
       y = "R-Squared Value", 
       caption = "Average R-squared value is shown by Blue Line")
```

Present and discuss the implications of the results of cross validation for the quality of your model

Discuss the implications of the values shown in this plot. How predictive is your model? How much does the performance vary between folds? Is there any evidence of over fitting?

## Conclusion

Throughout our analysis, we were curious about answering the central question proposed by Michele W. Berger: "Does more money correlate with greater happiness?" We have focused on the relationship between daily income and happiness, leading us to discover that there is indeed a positive relationship between the two. The dataset we used were prepared by omitting any countries and years that had missing values. Our linear regression model showed that there is strong evidence of a positive relationship happiness scores and daily income throughout the years 2005 to 2023 for over 150 countries. The model shows that this relationship explains for 56.29% of the variation in Happiness Score. For confirmation of this relationship, we conducted a 16-fold cross validation which showed that there was a consistent relationship, strengthening our findings.

The analysis of the positive relationship between daily income and happiness scores in various countries corroborates theories about the way money can help alleviate stressors caused by lack of finances. The increase of money can be used to access housing, better healthcare, more fulfilling experiences, and much more. Although we found that higher daily incomes are associated with higher happiness scores, happiness can be influenced by other things that are not gathered by daily income like personal values and religion.

Our model does have limitations. We can see that there is a positive relationship between daily income and happiness scores. However, it is important to acknowledge that there can be a point where money can have diminishing returns in terms of happiness. Infinite money would not necessarily mean infinite happiness. So, although money cannot buy happiness, money seems to be a basis where it can expand the opportunities to increase happiness.

## Works Cited

Berger, Michele W. “Does More Money Correlate with Greater Happiness?” Penn Today, University of Pennsylvania, 6 Mar. 2023, penntoday.upenn.edu/news/does-more-money-correlate-greater-happiness-Penn-Princeton-research.

Helliwell, John F., et al. "World Happiness Report 2024." The World Happiness Report, 20 Mar. 2024, [worldhappiness.report/ed/2024/](http://worldhappiness.report/ed/2024/).

"Poverty and Inequality Platform." Poverty and Inequality Platform, 2022, [pip.worldbank.org/#](http://pip.worldbank.org/#).
>>>>>>> 56bbb2649e18783b3b5f1c7d28e57bca86f74cc7
